// Twitter Toplu Tweet Silme Kodu - D√ºzeltilmi≈ü v2.1
// Bu kodu Twitter/X web sitesinde browser console'da √ßalƒ±≈ütƒ±rƒ±n

class TwitterBulkDeleter {
    constructor() {
        this.deletedCount = 0;
        this.isRunning = false;
        this.speed = 17; // ms (saniyede ~60 tweet - 3x hƒ±zlandƒ±rƒ±lmƒ±≈ü)
        this.maxRetries = 3;
        this.stats = {
            startTime: null,
            errors: 0,
            retries: 0
        };
        this.devMode = false;
        this.init();
    }

    init() {
        console.log(`
üöÄ TWITTER BULK DELETER v2.1 - DEV MODE AVAILABLE
=================================================

BASIC COMMANDS:
‚Ä¢ deleter.start()     - Silme i≈ülemini ba≈ülat
‚Ä¢ deleter.stop()      - ƒ∞≈ülemi durdur
‚Ä¢ deleter.status()    - Durum bilgisi g√∂ster

DEV MODE COMMANDS:
‚Ä¢ deleter.devModeToggle() - Geli≈ütirici modunu a√ß/kapat
‚Ä¢ deleter.setSpeed(n)     - Hƒ±z ayarla (ms, √∂rn: 100 = saniyede 10)
‚Ä¢ deleter.simulate()      - Test modu (ger√ßekten silmez)

ADVANCED:
‚Ä¢ deleter.debugMode()     - Hangi elementleri bulduƒüunu g√∂ster
        `);
    }

    devModeToggle() {
        this.devMode = !this.devMode;
        console.log(`üîß Dev Mode: ${this.devMode ? 'A√áIK' : 'KAPALI'}`);
        if (this.devMode) {
            console.log('üõ†Ô∏è Geli≈ütirici √∂zellikleri etkinle≈ütirildi');
        }
    }

    setSpeed(ms) {
        this.speed = ms;
        const tweetsPerSecond = Math.round(1000 / ms);
        console.log(`‚ö° Hƒ±z ayarlandƒ±: ${ms}ms (saniyede ~${tweetsPerSecond} tweet)`);
    }

    log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('tr-TR');
        const prefix = {
            'info': 'üîµ',
            'success': '‚úÖ',
            'error': '‚ùå',
            'warning': '‚ö†Ô∏è',
            'dev': 'üîß'
        };
        
        console.log(`${prefix[type]} [${timestamp}] ${message}`);
    }

    async findTweetElements() {
        // Tweet'lerin bulunduƒüu ana container'ƒ± bul
        const timeline = document.querySelector('[data-testid="primaryColumn"]') || 
                        document.querySelector('[role="main"]') ||
                        document.querySelector('main');
        
        if (!timeline) {
            this.log('Timeline bulunamadƒ±', 'error');
            return [];
        }

        // X (Twitter) i√ßin g√ºncel selector'lar
        const selectors = [
            '[data-testid="caret"]',
            'button[aria-label*="Daha"]',
            'button[aria-label*="More"]',
            '[data-testid="tweet"] button[aria-haspopup="menu"]',
            'div[role="button"][aria-haspopup="menu"]'
        ];

        for (const selector of selectors) {
            const elements = timeline.querySelectorAll(selector);
            if (elements.length > 0) {
                if (this.devMode) this.log(`${elements.length} adet tweet butonu bulundu: ${selector}`, 'dev');
                return Array.from(elements);
            }
        }
        
        this.log('Tweet butonlarƒ± bulunamadƒ±. Profilinizde olduƒüunuzdan emin olun.', 'warning');
        return [];
    }

    async deleteTweet(moreButton, simulate = false) {
        try {
            if (simulate) {
                this.log('SIMULATE: Tweet i≈ülemi yapƒ±lacaktƒ±', 'warning');
                return true;
            }

            // Elementin g√∂r√ºn√ºr olduƒüundan emin ol
            moreButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
            await this.wait(150); // Hƒ±zlandƒ±rƒ±ldƒ±: 300ms -> 150ms

            // Tweet container'ƒ±nƒ± bul ve RT mi yoksa kendi tweeti mi kontrol et
            const tweetContainer = moreButton.closest('[data-testid="tweet"]');
            if (!tweetContainer) {
                this.log('Tweet container bulunamadƒ±', 'error');
                return false;
            }

            // RT kontrol√º - "Yeniden g√∂nderdi" veya "retweeted" metni var mƒ±?
            const isRetweet = tweetContainer.textContent.includes('Yeniden g√∂nderdi') || 
                             tweetContainer.textContent.includes('retweeted') ||
                             tweetContainer.querySelector('[data-testid="socialContext"]');

            this.log(isRetweet ? 'RT tespit edildi - direkt RT butonuyla geri √ßekilecek' : 'Kendi tweeti - silinecek', 'info');

            // RT ise direkt RT butonunu bul ve tƒ±kla
            if (isRetweet) {
                // RT butonunu ara (ye≈üil renkli, aktif olan)
                const retweetButton = tweetContainer.querySelector('[data-testid="retweet"]') ||
                                    tweetContainer.querySelector('button[aria-label*="Retweet"]') ||
                                    tweetContainer.querySelector('button[aria-label*="g√∂nder"]');
                
                if (retweetButton) {
                    this.log('RT butonu bulundu, geri alƒ±nƒ±yor...', 'info');
                    retweetButton.click();
                    await this.wait(250); // Hƒ±zlandƒ±rƒ±ldƒ±: 500ms -> 250ms
                    
                    // RT geri alma onayƒ±nƒ± ara
                    const undoButton = document.querySelector('[data-testid="unretweetConfirm"]') ||
                                     document.querySelector('button:has-text("Retweet\'i geri al")') ||
                                     Array.from(document.querySelectorAll('button, div[role="menuitem"]')).find(btn => 
                                         btn.textContent.toLowerCase().includes('geri al') ||
                                         btn.textContent.toLowerCase().includes('undo')
                                     );
                    
                    if (undoButton) {
                        this.log('RT geri alma onayƒ± bulundu', 'success');
                        undoButton.click();
                        await this.wait(400); // Hƒ±zlandƒ±rƒ±ldƒ±: 800ms -> 400ms
                        return true;
                    } else {
                        this.log('RT geri alma onayƒ± bulunamadƒ±, men√º y√∂ntemiyle deneniyor...', 'warning');
                        // Men√º y√∂ntemine ge√ß
                    }
                } else {
                    this.log('RT butonu bulunamadƒ±, men√º y√∂ntemiyle deneniyor...', 'warning');
                }
            }

            // Kendi tweeti i√ßin veya RT men√º y√∂ntemi i√ßin √º√ß nokta men√ºs√ºn√º a√ß
            moreButton.click();
            await this.wait(400); // Hƒ±zlandƒ±rƒ±ldƒ±: 800ms -> 400ms

            let actionButton = null;
            
            for (let attempt = 0; attempt < 3; attempt++) {
                const menuItems = document.querySelectorAll('[role="menuitem"], [data-testid="menuItemButton"]');
                
                for (const item of menuItems) {
                    const text = item.textContent.toLowerCase();
                    
                    if (isRetweet) {
                        // RT i√ßin geri alma butonunu ara
                        if (text.includes('retweet\'i geri al') || 
                            text.includes('undo retweet') ||
                            text.includes('geri al') ||
                            text.includes('yeniden g√∂nderi')) {
                            actionButton = item;
                            break;
                        }
                    } else {
                        // Kendi tweeti i√ßin silme butonunu ara
                        if (text.includes('sil') || text.includes('delete') || 
                            text.includes('tweet\'i sil') || text.includes('g√∂nder')) {
                            actionButton = item;
                            break;
                        }
                    }
                }
                
                if (actionButton) break;
                await this.wait(150); // Hƒ±zlandƒ±rƒ±ldƒ±: 300ms -> 150ms
            }

            if (!actionButton) {
                this.log(isRetweet ? 'RT geri alma butonu bulunamadƒ±' : 'Sil butonu bulunamadƒ±', 'warning');
                
                if (this.devMode) {
                    const menuItems = document.querySelectorAll('[role="menuitem"], [data-testid="menuItemButton"]');
                    menuItems.forEach((item, index) => {
                        this.log(`Men√º ${index}: "${item.textContent.trim()}"`, 'dev');
                    });
                }
                
                document.body.click();
                await this.wait(150); // Hƒ±zlandƒ±rƒ±ldƒ±: 300ms -> 150ms
                return false;
            }

            const actionType = isRetweet ? 'RT geri alƒ±nƒ±yor' : 'Tweet siliniyor';
            this.log(`${actionType}: "${actionButton.textContent.trim()}"`, 'info');
            actionButton.click();
            await this.wait(250); // Hƒ±zlandƒ±rƒ±ldƒ±: 500ms -> 250ms

            // RT geri alma i√ßin onay gerekmez genelde, ama kontrol et
            if (isRetweet) {
                this.log('‚úÖ RT ba≈üarƒ±yla geri alƒ±ndƒ±', 'success');
                await this.wait(400); // Hƒ±zlandƒ±rƒ±ldƒ±: 800ms -> 400ms
                return true;
            }

            // Tweet silme i√ßin onay butonunu bul
            let confirmButton = null;
            
            for (let attempt = 0; attempt < 5; attempt++) {
                const allButtons = document.querySelectorAll('button, div[role="button"]');
                
                confirmButton = Array.from(allButtons).find(btn => {
                    const text = btn.textContent.toLowerCase();
                    return (text.includes('sil') || text.includes('delete')) && 
                           !btn.closest('[role="menu"]') &&
                           (btn.getAttribute('data-testid') === 'confirmationSheetConfirm' ||
                            text === 'sil' || text === 'delete');
                });
                
                if (confirmButton) break;
                await this.wait(100); // Hƒ±zlandƒ±rƒ±ldƒ±: 200ms -> 100ms
            }
            
            if (confirmButton) {
                this.log('Onay butonu bulundu, tweet siliniyor...', 'success');
                confirmButton.click();
                await this.wait(400); // Hƒ±zlandƒ±rƒ±ldƒ±: 800ms -> 400ms
                return true;
            } else {
                this.log('Onay butonu bulunamadƒ±', 'error');
                return false;
            }

        } catch (error) {
            this.stats.errors++;
            this.log(`ƒ∞≈ülem hatasƒ±: ${error.message}`, 'error');
            
            document.body.click();
            await this.wait(250); // Hƒ±zlandƒ±rƒ±ldƒ±: 500ms -> 250ms
            return false;
        }
    }

    async wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async start(simulate = false) {
        if (this.isRunning) {
            this.log('Silme i≈ülemi zaten √ßalƒ±≈üƒ±yor...', 'warning');
            return;
        }

        // Basit profil kontrol√º - sadece x.com olup olmadƒ±ƒüƒ±nƒ± kontrol et
        if (!window.location.href.includes('x.com/')) {
            this.log('‚ùå L√ºtfen X.com sayfasƒ±nda olduƒüunuzdan emin olun!', 'error');
            return;
        }
        
        this.log('‚úÖ X.com sayfasƒ±nda, i≈üleme devam ediliyor...', 'info');

        this.isRunning = true;
        this.stats.startTime = Date.now();
        this.stats.retries = 0;
        this.log(`üöÄ ƒ∞≈ülem ba≈ülatƒ±lƒ±yor... ${simulate ? '(Sƒ∞M√úLASYON MODU)' : ''}`, 'info');
        
        let consecutiveFailures = 0;
        
        while (this.isRunning) {
            const tweetElements = await this.findTweetElements();
            
            if (tweetElements.length === 0) {
                consecutiveFailures++;
                if (consecutiveFailures >= 3) {
                    this.log('‚ùå √úst √ºste 3 kez tweet bulunamadƒ±. ƒ∞≈ülem durduruluyor.', 'error');
                    this.log('üí° Sayfayƒ± yenileyin ve tekrar deneyin.', 'info');
                    break;
                }
                this.log('‚ö†Ô∏è Tweet bulunamadƒ±, 1.5 saniye bekleyip tekrar deneniyor...', 'warning');
                await this.wait(1500); // Hƒ±zlandƒ±rƒ±ldƒ±: 3000ms -> 1500ms
                continue;
            }

            consecutiveFailures = 0; // Ba≈üarƒ±lƒ± bulma durumunda sƒ±fƒ±rla
            
            const success = await this.deleteTweet(tweetElements[0], simulate);
            
            if (success) {
                this.deletedCount++;
                this.log(`‚úÖ ${this.deletedCount} i≈ülem tamamlandƒ± (RT geri alƒ±ndƒ± veya tweet silindi)`, 'success');
                this.stats.retries = 0;
            } else {
                this.stats.retries++;
                this.log(`‚ùå Hata! Yeniden deneme: ${this.stats.retries}/${this.maxRetries}`, 'warning');
                
                if (this.stats.retries >= this.maxRetries) {
                    this.log('‚ùå √áok fazla hata. ƒ∞≈ülem durduruldu.', 'error');
                    break;
                }
                
                await this.wait(1000); // Hƒ±zlandƒ±rƒ±ldƒ±: 2000ms -> 1000ms
                continue;
            }

            await this.wait(this.speed);
        }

        this.stop();
    }

    stop() {
        this.isRunning = false;
        const duration = this.stats.startTime ? (Date.now() - this.stats.startTime) / 1000 : 0;
        this.log(`üõë ƒ∞≈ülem durduruldu. S√ºre: ${duration.toFixed(1)}s`, 'info');
        this.log(`üìä Toplam silinen: ${this.deletedCount}`, 'success');
    }

    status() {
        const duration = this.stats.startTime ? (Date.now() - this.stats.startTime) / 1000 : 0;
        console.table({
            'Durum': this.isRunning ? 'üü¢ √áALI≈ûIYOR' : 'üî¥ DURDU',
            'Silinen Tweet': this.deletedCount,
            'Hƒ±z (ms)': this.speed,
            'S√ºre (sn)': duration.toFixed(1),
            'Hata Sayƒ±sƒ±': this.stats.errors,
            'Yeniden Deneme': this.stats.retries,
            'Dev Mode': this.devMode ? 'üü¢ A√áIK' : 'üî¥ KAPALI'
        });
    }

    simulate() {
        this.log('üß™ Test modu ba≈ülatƒ±lƒ±yor...', 'warning');
        this.start(true);
    }

    debugMode() {
        this.log('üîç Debug modu - elementler taranƒ±yor...', 'info');
        
        const timeline = document.querySelector('[data-testid="primaryColumn"]') || 
                        document.querySelector('[role="main"]');
        
        if (!timeline) {
            this.log('‚ùå Timeline bulunamadƒ±', 'error');
            return;
        }

        const selectors = [
            '[data-testid="caret"]',
            'button[aria-label*="Daha"]',
            'button[aria-label*="More"]',
            '[data-testid="tweet"] button[aria-haspopup="menu"]'
        ];

        selectors.forEach(selector => {
            const elements = timeline.querySelectorAll(selector);
            console.log(`üîç ${selector}: ${elements.length} adet`);
        });

        // Tweet container'larƒ±nƒ± da kontrol et
        const tweets = timeline.querySelectorAll('[data-testid="tweet"]');
        console.log(`üê¶ Toplam tweet container: ${tweets.length}`);
    }
}

// Global instance olu≈ütur
const deleter = new TwitterBulkDeleter();

// Kƒ±sayollar
const start = () => deleter.start();
const stop = () => deleter.stop();
const status = () => deleter.status();
const devMode = () => deleter.devModeToggle();
const simulate = () => deleter.simulate();
const debug = () => deleter.debugMode();

console.log(`
üéØ HIZLI KOMUTLAR:
‚Ä¢ start()    - ƒ∞≈ülemi ba≈ülat
‚Ä¢ stop()     - ƒ∞≈ülemi durdur  
‚Ä¢ status()   - Durum g√∂ster
‚Ä¢ simulate() - Test modu
‚Ä¢ debug()    - Element kontrol√º
‚Ä¢ devMode()  - Dev mode a√ß/kapat
`);